<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat avec {{ friend.username }} - 3DChat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="chat-header">
            <a href="{{ url_for('private_messages') }}?user={{ user.username }}" class="btn btn-small">← Retour</a>
            <div class="friend-avatar">
                {% if friend.profile_image %}
                    <img src="{{ friend.profile_image }}" alt="Photo de {{ friend.username }}">
                {% else %}
                    {{ friend.username[0].upper() }}
                {% endif %}
            </div>
            <div class="friend-info">
                <div class="friend-name">{{ friend.username }}</div>
                <div class="friend-status {{ 'online' if friend.status == 'online' else 'offline' }}">
                    {{ '🟢 En ligne' if friend.status == 'online' else '⚫ Hors ligne' }}
                </div>
            </div>
            <a href="{{ url_for('user_profile', user_id=friend.id) }}?user={{ user.username }}" class="btn btn-small">Profil</a>
            <button onclick="startCall()" class="btn btn-small btn-call" id="call-btn">📞 Appeler</button>
            <button onclick="testCallNotification()" class="btn btn-small" style="background: #faa61a;">🔔 Test Notification</button>
        </div>

        <div class="chat-messages" id="messages">
            {% for message in messages %}
            <div class="private-message {{ 'own' if message.sender_id == user.id else 'other' }}">
                <div class="message-content">{{ message.content }}</div>
                <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
            </div>
            {% endfor %}
        </div>

        <form class="message-form" id="message-form" onsubmit="sendMessage(event)">
            <div class="form-group">
                <input type="text" id="message-input" name="message" placeholder="Tapez votre message..." maxlength="500" required>
                <button type="submit" class="btn btn-primary" id="send-btn">Envoyer</button>
            </div>
        </form>
    </div>

    <!-- Interface d'appel -->
    <div class="call-overlay" id="call-overlay" style="display: none;">
        <div class="call-container">
            <div class="call-header">
                <div class="call-avatar">
                    {% if friend.profile_image %}
                        <img src="{{ friend.profile_image }}" alt="Photo de {{ friend.username }}">
                    {% else %}
                        {{ friend.username[0].upper() }}
                    {% endif %}
                </div>
                <div class="call-info">
                    <div class="call-name">{{ friend.username }}</div>
                    <div class="call-status" id="call-status">Appel en cours...</div>
                </div>
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn mute-btn" id="mute-btn" onclick="toggleMute()">
                    <span id="mute-icon">🔊</span>
                </button>
                <button class="call-control-btn video-btn" id="video-btn" onclick="toggleVideo()">
                    <span id="video-icon">📹</span>
                </button>
                <button class="call-control-btn end-btn" onclick="endCall()">
                    📞
                </button>
            </div>
            
            <div class="call-duration" id="call-duration">00:00</div>
            
            <!-- Zone vidéo -->
            <div class="video-container" id="video-container" style="display: none;">
                <video id="local-video" autoplay muted playsinline></video>
                <video id="remote-video" autoplay playsinline></video>
            </div>
        </div>
    </div>

    <!-- Notification d'appel entrant -->
    <div class="incoming-call-overlay" id="incoming-call-overlay" style="display: none;">
        <div class="incoming-call-container">
            <div class="incoming-call-header">
                <div class="call-avatar">
                    <span id="caller-avatar"></span>
                </div>
                <div class="incoming-call-info">
                    <div class="caller-name" id="caller-name"></div>
                    <div class="call-status">Appel entrant...</div>
                </div>
            </div>
            
            <div class="incoming-call-controls">
                <button class="call-control-btn accept-btn" onclick="acceptCall()">
                    📞
                </button>
                <button class="call-control-btn decline-btn" onclick="declineCall()">
                    ❌
                </button>
            </div>
        </div>
    </div>

    <!-- Popup de notification d'appel -->
    <div class="call-notification-popup" id="call-notification-popup" style="display: none;">
        <div class="notification-content">
            <div class="notification-icon">📞</div>
            <div class="notification-info">
                <div class="notification-caller" id="notification-caller">Appel entrant</div>
                <div class="notification-actions">
                    <button onclick="acceptIncomingCall()" class="notification-btn accept">Répondre</button>
                    <button onclick="dismissNotification()" class="notification-btn dismiss">Ignorer</button>
                </div>
            </div>
            <button onclick="dismissNotification()" class="notification-close">✕</button>
        </div>
    </div>

    <script>
        // Détection 3DS
        var is3DS = navigator.userAgent.indexOf('Nintendo 3DS') !== -1;
        var pollingInterval;
        
        function updatePrivateMessages() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_private_messages/{{ friend.id }}?user={{ user.username }}', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var messagesContainer = document.getElementById('messages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = xhr.responseText;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            };
            
            xhr.send();
        }
        
        function sendMessage(event) {
            event.preventDefault(); // Empêcher le rechargement de page
            
            var messageInput = document.getElementById('message-input');
            var sendBtn = document.getElementById('send-btn');
            var message = messageInput.value.trim();
            
            if (!message) return;
            
            // Désactiver le bouton temporairement
            sendBtn.disabled = true;
            sendBtn.textContent = 'Envoi...';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/send_private_message/{{ friend.id }}?user={{ user.username }}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // Réactiver le bouton
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Envoyer';
                    
                    if (xhr.status === 200) {
                        // Vider le champ de message
                        messageInput.value = '';
                        // Mettre à jour les messages immédiatement
                        updatePrivateMessages();
                    }
                }
            };
            
            xhr.send('message=' + encodeURIComponent(message));
        }
        
        // Polling plus agressif pour 3DS
        if (is3DS) {
            // Polling toutes les 1.5 secondes pour 3DS
            pollingInterval = setInterval(updatePrivateMessages, 1500);
            console.log('3DS: Polling activé toutes les 1.5s');
        } else {
            // Polling toutes les 3 secondes pour autres navigateurs
            pollingInterval = setInterval(updatePrivateMessages, 3000);
        }
        
        // Auto-scroll vers le bas au chargement initial
        window.onload = function() {
            var messagesContainer = document.getElementById('messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Focus sur le champ de message (pas sur 3DS car ça peut causer des problèmes)
            if (!is3DS) {
                var messageInput = document.querySelector('input[name="message"]');
                if (messageInput) {
                    messageInput.focus();
                }
            }
        };
        
        // Arrêter le polling quand on quitte la page
        window.onbeforeunload = function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        };
        
        // Variables pour les appels
        var isInCall = false;
        var callTimer = null;
        var callStartTime = null;
        var isMuted = false;
        var isVideoEnabled = true;
        var localStream = null;
        var peerConnection = null;
        var localVideo = null;
        var remoteVideo = null;
        var signalPolling = null;
        var friendId = {{ friend.id }};
        
        // Configuration ICE servers (STUN/TURN)
        var iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // Fonction pour démarrer un appel
        function startCall() {
            if (isInCall) return;
            
            var callOverlay = document.getElementById('call-overlay');
            var callStatus = document.getElementById('call-status');
            var callBtn = document.getElementById('call-btn');
            
            isInCall = true;
            callOverlay.style.display = 'flex';
            callStatus.textContent = 'Initialisation...';
            callBtn.textContent = '📞 En appel';
            callBtn.disabled = true;
            
            // Initialiser les éléments vidéo
            localVideo = document.getElementById('local-video');
            remoteVideo = document.getElementById('remote-video');
            
            // Demander accès caméra et micro
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    localStream = stream;
                    if (localVideo) {
                        localVideo.srcObject = stream;
                    }
                    
                    callStatus.textContent = 'Connexion...';
                    
                    // Créer la connexion WebRTC
                    createPeerConnection();
                    
                    // Ajouter le stream local à la connexion
                    localStream.getTracks().forEach(function(track) {
                        peerConnection.addTrack(track, localStream);
                    });
                    
                    // Créer une offre WebRTC
                    peerConnection.createOffer()
                        .then(function(offer) {
                            return peerConnection.setLocalDescription(offer);
                        })
                        .then(function() {
                            // Envoyer l'offre via le serveur de signalisation
                            sendSignal('offer', peerConnection.localDescription);
                            
                            // Démarrer le polling pour les réponses
                            startSignalPolling();
                            
                            callStatus.textContent = 'Appel en cours...';
                        })
                        .catch(function(error) {
                            console.error('Erreur création offre:', error);
                            endCall();
                        });
                })
                .catch(function(error) {
                    console.error('Erreur accès média:', error);
                    alert('Impossible d\'accéder à la caméra/microphone. Vérifiez les permissions.');
                    endCall();
                });
        }
        
        // Fonction pour accepter un appel entrant
        function acceptCall() {
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            var callOverlay = document.getElementById('call-overlay');
            var callStatus = document.getElementById('call-status');
            
            incomingOverlay.style.display = 'none';
            dismissNotification();
            callOverlay.style.display = 'flex';
            callStatus.textContent = 'Initialisation...';
            
            // Initialiser les éléments vidéo
            localVideo = document.getElementById('local-video');
            remoteVideo = document.getElementById('remote-video');
            
            // Demander accès caméra et micro
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    localStream = stream;
                    if (localVideo) {
                        localVideo.srcObject = stream;
                    }
                    
                    isInCall = true;
                    callStatus.textContent = 'En attente de connexion...';
                    startCallTimer();
                    showVideoContainer();
                    
                    // Démarrer le polling pour recevoir l'offre
                    startSignalPolling();
                    
                    console.log('Appel accepté avec média');
                })
                .catch(function(error) {
                    console.error('Erreur accès média:', error);
                    alert('Impossible d\'accéder à la caméra/microphone.');
                    endCall();
                });
        }
        
        // Fonction pour refuser un appel entrant
        function declineCall() {
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            incomingOverlay.style.display = 'none';
            dismissNotification();
            
            console.log('Appel refusé');
        }
        
        // Fonctions pour la popup de notification
        function showCallNotification(callerName) {
            var popup = document.getElementById('call-notification-popup');
            var callerElement = document.getElementById('notification-caller');
            
            if (callerElement) {
                callerElement.textContent = callerName + ' vous appelle';
            }
            
            if (popup) {
                popup.style.display = 'block';
                popup.style.animation = 'slideInFromRight 0.3s ease-out';
                
                // Auto-dismiss après 30 secondes si pas de réaction
                setTimeout(function() {
                    if (popup.style.display !== 'none') {
                        dismissNotification();
                    }
                }, 30000);
            }
        }
        
        function dismissNotification() {
            var popup = document.getElementById('call-notification-popup');
            
            if (popup) {
                popup.style.animation = 'slideOutToRight 0.3s ease-out';
                setTimeout(function() {
                    popup.style.display = 'none';
                }, 300);
            }
        }
        
        function acceptIncomingCall() {
            dismissNotification();
            showIncomingCall();
        }
        
        function showIncomingCall() {
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            if (incomingOverlay) {
                incomingOverlay.style.display = 'flex';
            }
        }
        
        // Fonction de test pour la popup de notification
        function testCallNotification() {
            showCallNotification('{{ friend.username }}');
        }
        
        // Fonction pour terminer l'appel
        function endCall() {
            var callOverlay = document.getElementById('call-overlay');
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            var callBtn = document.getElementById('call-btn');
            var videoContainer = document.getElementById('video-container');
            
            // Calculer la durée si on était en appel
            var duration = 0;
            if (callStartTime) {
                duration = Math.floor((new Date() - callStartTime) / 1000);
            }
            
            // Arrêter le polling de signalisation
            if (signalPolling) {
                clearInterval(signalPolling);
                signalPolling = null;
            }
            
            // Arrêter tous les flux média
            if (localStream) {
                localStream.getTracks().forEach(function(track) {
                    track.stop();
                });
                localStream = null;
            }
            
            // Fermer la connexion peer
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Réinitialiser les vidéos
            if (localVideo) {
                localVideo.srcObject = null;
            }
            if (remoteVideo) {
                remoteVideo.srcObject = null;
            }
            
            isInCall = false;
            callOverlay.style.display = 'none';
            incomingOverlay.style.display = 'none';
            if (videoContainer) {
                videoContainer.style.display = 'none';
            }
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
                callStartTime = null;
            }
            
            if (callBtn) {
                callBtn.textContent = '📞 Appeler';
                callBtn.disabled = false;
            }
            
            // Réinitialiser les états
            isMuted = false;
            isVideoEnabled = true;
            updateMuteButton();
            updateVideoButton();
            
            // Notifier le serveur de la fin d'appel
            if (duration > 0) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/end_call', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.send(JSON.stringify({
                    other_user_id: friendId,
                    duration: duration
                }));
            }
            
            console.log('Appel terminé (durée: ' + duration + 's)');
        }
        
        // Fonction pour activer/désactiver le micro
        function toggleMute() {
            isMuted = !isMuted;
            
            if (localStream) {
                var audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(function(track) {
                    track.enabled = !isMuted;
                });
            }
            
            updateMuteButton();
            console.log('Micro ' + (isMuted ? 'coupé' : 'activé'));
        }
        
        // Fonction pour activer/désactiver la vidéo
        function toggleVideo() {
            isVideoEnabled = !isVideoEnabled;
            
            if (localStream) {
                var videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(function(track) {
                    track.enabled = isVideoEnabled;
                });
            }
            
            var videoContainer = document.getElementById('video-container');
            if (videoContainer) {
                if (isVideoEnabled) {
                    videoContainer.style.display = 'block';
                } else {
                    videoContainer.style.display = 'none';
                }
            }
            
            updateVideoButton();
            console.log('Vidéo ' + (isVideoEnabled ? 'activée' : 'désactivée'));
        }
        
        // Mettre à jour l'icône du micro
        function updateMuteButton() {
            var muteBtn = document.getElementById('mute-btn');
            var muteIcon = document.getElementById('mute-icon');
            
            if (muteBtn && muteIcon) {
                if (isMuted) {
                    muteBtn.classList.add('muted');
                    muteIcon.textContent = '🔇';
                } else {
                    muteBtn.classList.remove('muted');
                    muteIcon.textContent = '🔊';
                }
            }
        }
        
        // Mettre à jour l'icône de la vidéo
        function updateVideoButton() {
            var videoIcon = document.getElementById('video-icon');
            
            if (videoIcon) {
                videoIcon.textContent = isVideoEnabled ? '📹' : '📷';
            }
        }
        
        // Timer pour l'appel
        function startCallTimer() {
            callStartTime = new Date();
            callTimer = setInterval(updateCallDuration, 1000);
        }
        
        // Mettre à jour la durée de l'appel
        function updateCallDuration() {
            if (!callStartTime) return;
            
            var currentTime = new Date();
            var duration = Math.floor((currentTime - callStartTime) / 1000);
            
            var minutes = Math.floor(duration / 60);
            var seconds = duration % 60;
            
            var formattedTime = String(minutes).padStart(2, '0') + ':' + 
                               String(seconds).padStart(2, '0');
            
            var durationElement = document.getElementById('call-duration');
            if (durationElement) {
                durationElement.textContent = formattedTime;
            }
        }
        
        // Simuler un appel entrant (pour tester)
        function simulateIncomingCall(callerName, callerAvatar) {
            if (isInCall) return;
            
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            var callerNameElement = document.getElementById('caller-name');
            var callerAvatarElement = document.getElementById('caller-avatar');
            
            if (callerNameElement) callerNameElement.textContent = callerName;
            if (callerAvatarElement) {
                callerAvatarElement.textContent = callerAvatar || callerName.charAt(0).toUpperCase();
            }
            
            incomingOverlay.style.display = 'flex';
            
            // Son de notification (simulation)
            console.log('📞 Appel entrant de ' + callerName);
        }
        
        // Fonction pour afficher le conteneur vidéo
        function showVideoContainer() {
            var videoContainer = document.getElementById('video-container');
            if (videoContainer && isVideoEnabled) {
                videoContainer.style.display = 'block';
            }
        }
        
        // Fonction pour créer une connexion WebRTC
        function createPeerConnection() {
            console.log('Création connexion WebRTC');
            peerConnection = new RTCPeerConnection(iceServers);
            
            // Gérer les candidats ICE
            peerConnection.onicecandidate = function(event) {
                if (event.candidate) {
                    console.log('Candidat ICE local:', event.candidate.candidate);
                    sendSignal('ice-candidate', event.candidate);
                } else {
                    console.log('Collecte ICE terminée');
                }
            };
            
            // Gérer le stream distant
            peerConnection.ontrack = function(event) {
                console.log('Stream distant reçu:', event.streams[0]);
                if (remoteVideo) {
                    remoteVideo.srcObject = event.streams[0];
                }
                
                // Appel connecté !
                var callStatus = document.getElementById('call-status');
                if (callStatus) {
                    callStatus.textContent = 'Connecté - Audio/Vidéo actifs';
                }
            };
            
            // Gérer les changements de connexion
            peerConnection.onconnectionstatechange = function() {
                var state = peerConnection.connectionState;
                console.log('État connexion WebRTC:', state);
                
                var callStatus = document.getElementById('call-status');
                if (callStatus) {
                    if (state === 'connected') {
                        callStatus.textContent = 'Connecté - Communication établie';
                    } else if (state === 'connecting') {
                        callStatus.textContent = 'Connexion en cours...';
                    } else if (state === 'failed') {
                        callStatus.textContent = 'Connexion échouée';
                    }
                }
            };
            
            // Debug signaling state
            peerConnection.onsignalingstatechange = function() {
                console.log('État signalisation:', peerConnection.signalingState);
            };
            
            // Debug ICE state
            peerConnection.oniceconnectionstatechange = function() {
                console.log('État ICE:', peerConnection.iceConnectionState);
            };
        }
        
        // Fonction pour envoyer un signal WebRTC
        function sendSignal(type, data) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/webrtc_signal', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.send(JSON.stringify({
                type: type,
                target_user_id: friendId,
                data: data
            }));
        }
        
        // Fonction pour démarrer le polling des signaux
        function startSignalPolling() {
            signalPolling = setInterval(function() {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/webrtc_poll/' + friendId, true);
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            handleSignals(response.signals);
                        } catch (e) {
                            console.error('Erreur parsing signaux:', e);
                        }
                    }
                };
                
                xhr.send();
            }, 1000); // Polling chaque seconde
        }
        
        // Fonction pour gérer les signaux reçus
        function handleSignals(signals) {
            signals.forEach(function(signal) {
                if (signal.type === 'offer') {
                    handleOffer(signal.data);
                } else if (signal.type === 'answer') {
                    handleAnswer(signal.data);
                } else if (signal.type === 'ice-candidate') {
                    handleIceCandidate(signal.data);
                }
            });
        }
        
        // Gérer une offre reçue
        function handleOffer(offer) {
            if (!peerConnection) {
                createPeerConnection();
            }
            
            // S'assurer qu'on a le media local d'abord
            if (!localStream) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(function(stream) {
                        localStream = stream;
                        if (localVideo) {
                            localVideo.srcObject = stream;
                        }
                        
                        // Maintenant traiter l'offre
                        processOffer(offer);
                    })
                    .catch(function(error) {
                        console.error('Erreur accès média pour réponse:', error);
                    });
            } else {
                processOffer(offer);
            }
        }
        
        function processOffer(offer) {
            console.log('Traitement offre reçue');
            
            peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(function() {
                    console.log('Description distante définie');
                    
                    // Ajouter notre stream local
                    if (localStream) {
                        localStream.getTracks().forEach(function(track) {
                            console.log('Ajout track:', track.kind);
                            peerConnection.addTrack(track, localStream);
                        });
                    }
                    
                    // Créer une réponse
                    return peerConnection.createAnswer();
                })
                .then(function(answer) {
                    console.log('Réponse créée');
                    return peerConnection.setLocalDescription(answer);
                })
                .then(function() {
                    console.log('Description locale définie');
                    sendSignal('answer', peerConnection.localDescription);
                    console.log('Réponse envoyée');
                })
                .catch(function(error) {
                    console.error('Erreur détaillée gestion offre:', error);
                });
        }
        
        // Gérer une réponse reçue
        function handleAnswer(answer) {
            console.log('Réponse reçue:', answer);
            
            if (peerConnection && peerConnection.signalingState === 'have-local-offer') {
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                    .then(function() {
                        console.log('Réponse WebRTC acceptée, état:', peerConnection.signalingState);
                    })
                    .catch(function(error) {
                        console.error('Erreur détaillée gestion réponse:', error);
                    });
            } else {
                console.warn('État incorrect pour accepter réponse:', 
                    peerConnection ? peerConnection.signalingState : 'pas de connexion');
            }
        }
        
        // Gérer un candidat ICE reçu
        function handleIceCandidate(candidate) {
            if (peerConnection && peerConnection.remoteDescription) {
                peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                    .then(function() {
                        console.log('Candidat ICE ajouté:', candidate.candidate);
                    })
                    .catch(function(error) {
                        console.error('Erreur ajout ICE candidate:', error, candidate);
                    });
            } else {
                console.log('Candidat ICE en attente (pas de description distante)');
                // Stocker pour plus tard si besoin
            }
        }
        
        // Vérifier la compatibilité WebRTC
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.warn('WebRTC n\'est pas supporté sur ce navigateur');
            // L'appel fonctionnera en mode audio/vidéo simulé pour la 3DS
        }
    </script>
</body>
</html>