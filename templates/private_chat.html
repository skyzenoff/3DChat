<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat avec {{ friend.username }} - 3DChat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="chat-header">
            <a href="{{ url_for('private_messages') }}?user={{ user.username }}" class="btn btn-small">‚Üê Retour</a>
            <div class="friend-avatar">
                {% if friend.profile_image %}
                    <img src="{{ friend.profile_image }}" alt="Photo de {{ friend.username }}">
                {% else %}
                    {{ friend.username[0].upper() }}
                {% endif %}
            </div>
            <div class="friend-info">
                <div class="friend-name">{{ friend.username }}</div>
                <div class="friend-status {{ 'online' if friend.status == 'online' else 'offline' }}">
                    {{ 'üü¢ En ligne' if friend.status == 'online' else '‚ö´ Hors ligne' }}
                </div>
            </div>
            <a href="{{ url_for('user_profile', user_id=friend.id) }}?user={{ user.username }}" class="btn btn-small">Profil</a>
            <button onclick="startCall()" class="btn btn-small btn-call" id="call-btn">üìû Appeler</button>
            <button onclick="simulateIncomingCall('{{ friend.username }}', '')" class="btn btn-small" style="background: #faa61a;">üîî Test appel</button>
        </div>

        <div class="chat-messages" id="messages">
            {% for message in messages %}
            <div class="private-message {{ 'own' if message.sender_id == user.id else 'other' }}">
                <div class="message-content">{{ message.content }}</div>
                <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
            </div>
            {% endfor %}
        </div>

        <form class="message-form" id="message-form" onsubmit="sendMessage(event)">
            <div class="form-group">
                <input type="text" id="message-input" name="message" placeholder="Tapez votre message..." maxlength="500" required>
                <button type="submit" class="btn btn-primary" id="send-btn">Envoyer</button>
            </div>
        </form>
    </div>

    <!-- Interface d'appel -->
    <div class="call-overlay" id="call-overlay" style="display: none;">
        <div class="call-container">
            <div class="call-header">
                <div class="call-avatar">
                    {% if friend.profile_image %}
                        <img src="{{ friend.profile_image }}" alt="Photo de {{ friend.username }}">
                    {% else %}
                        {{ friend.username[0].upper() }}
                    {% endif %}
                </div>
                <div class="call-info">
                    <div class="call-name">{{ friend.username }}</div>
                    <div class="call-status" id="call-status">Appel en cours...</div>
                </div>
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn mute-btn" id="mute-btn" onclick="toggleMute()">
                    <span id="mute-icon">üîä</span>
                </button>
                <button class="call-control-btn video-btn" id="video-btn" onclick="toggleVideo()">
                    <span id="video-icon">üìπ</span>
                </button>
                <button class="call-control-btn end-btn" onclick="endCall()">
                    üìû
                </button>
            </div>
            
            <div class="call-duration" id="call-duration">00:00</div>
            
            <!-- Zone vid√©o -->
            <div class="video-container" id="video-container" style="display: none;">
                <video id="local-video" autoplay muted playsinline></video>
                <video id="remote-video" autoplay playsinline></video>
            </div>
        </div>
    </div>

    <!-- Notification d'appel entrant -->
    <div class="incoming-call-overlay" id="incoming-call-overlay" style="display: none;">
        <div class="incoming-call-container">
            <div class="incoming-call-header">
                <div class="call-avatar">
                    <span id="caller-avatar"></span>
                </div>
                <div class="incoming-call-info">
                    <div class="caller-name" id="caller-name"></div>
                    <div class="call-status">Appel entrant...</div>
                </div>
            </div>
            
            <div class="incoming-call-controls">
                <button class="call-control-btn accept-btn" onclick="acceptCall()">
                    üìû
                </button>
                <button class="call-control-btn decline-btn" onclick="declineCall()">
                    ‚ùå
                </button>
            </div>
        </div>
    </div>

    <script>
        // D√©tection 3DS
        var is3DS = navigator.userAgent.indexOf('Nintendo 3DS') !== -1;
        var pollingInterval;
        
        function updatePrivateMessages() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_private_messages/{{ friend.id }}?user={{ user.username }}', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var messagesContainer = document.getElementById('messages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = xhr.responseText;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            };
            
            xhr.send();
        }
        
        function sendMessage(event) {
            event.preventDefault(); // Emp√™cher le rechargement de page
            
            var messageInput = document.getElementById('message-input');
            var sendBtn = document.getElementById('send-btn');
            var message = messageInput.value.trim();
            
            if (!message) return;
            
            // D√©sactiver le bouton temporairement
            sendBtn.disabled = true;
            sendBtn.textContent = 'Envoi...';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/send_private_message/{{ friend.id }}?user={{ user.username }}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // R√©activer le bouton
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Envoyer';
                    
                    if (xhr.status === 200) {
                        // Vider le champ de message
                        messageInput.value = '';
                        // Mettre √† jour les messages imm√©diatement
                        updatePrivateMessages();
                    }
                }
            };
            
            xhr.send('message=' + encodeURIComponent(message));
        }
        
        // Polling plus agressif pour 3DS
        if (is3DS) {
            // Polling toutes les 1.5 secondes pour 3DS
            pollingInterval = setInterval(updatePrivateMessages, 1500);
            console.log('3DS: Polling activ√© toutes les 1.5s');
        } else {
            // Polling toutes les 3 secondes pour autres navigateurs
            pollingInterval = setInterval(updatePrivateMessages, 3000);
        }
        
        // Auto-scroll vers le bas au chargement initial
        window.onload = function() {
            var messagesContainer = document.getElementById('messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Focus sur le champ de message (pas sur 3DS car √ßa peut causer des probl√®mes)
            if (!is3DS) {
                var messageInput = document.querySelector('input[name="message"]');
                if (messageInput) {
                    messageInput.focus();
                }
            }
        };
        
        // Arr√™ter le polling quand on quitte la page
        window.onbeforeunload = function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        };
        
        // Variables pour les appels
        var isInCall = false;
        var callTimer = null;
        var callStartTime = null;
        var isMuted = false;
        var isVideoEnabled = true;
        var localStream = null;
        var peerConnection = null;
        var localVideo = null;
        var remoteVideo = null;
        
        // Fonction pour d√©marrer un appel
        function startCall() {
            if (isInCall) return;
            
            var callOverlay = document.getElementById('call-overlay');
            var callStatus = document.getElementById('call-status');
            var callBtn = document.getElementById('call-btn');
            
            isInCall = true;
            callOverlay.style.display = 'flex';
            callStatus.textContent = 'Initialisation...';
            callBtn.textContent = 'üìû En appel';
            callBtn.disabled = true;
            
            // Initialiser les √©l√©ments vid√©o
            localVideo = document.getElementById('local-video');
            remoteVideo = document.getElementById('remote-video');
            
            // Demander acc√®s cam√©ra et micro
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    localStream = stream;
                    if (localVideo) {
                        localVideo.srcObject = stream;
                    }
                    
                    callStatus.textContent = 'Appel en cours...';
                    
                    // Appeler l'API backend pour initier l'appel
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', '/initiate_call/{{ friend.id }}', true);
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                try {
                                    var response = JSON.parse(xhr.responseText);
                                    if (response.success) {
                                        // Connecter apr√®s 2 secondes
                                        setTimeout(function() {
                                            callStatus.textContent = 'Connect√©';
                                            startCallTimer();
                                            showVideoContainer();
                                            console.log('Appel connect√© avec ' + response.friend_name);
                                        }, 2000);
                                    } else {
                                        console.error('Erreur appel:', response.error);
                                        endCall();
                                        alert('Erreur: ' + response.error);
                                    }
                                } catch (e) {
                                    console.error('Erreur parsing r√©ponse appel:', e);
                                    endCall();
                                }
                            } else {
                                console.error('Erreur HTTP appel:', xhr.status);
                                endCall();
                            }
                        }
                    };
                    
                    xhr.send();
                })
                .catch(function(error) {
                    console.error('Erreur acc√®s m√©dia:', error);
                    alert('Impossible d\'acc√©der √† la cam√©ra/microphone. V√©rifiez les permissions.');
                    endCall();
                });
        }
        
        // Fonction pour accepter un appel entrant
        function acceptCall() {
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            var callOverlay = document.getElementById('call-overlay');
            var callStatus = document.getElementById('call-status');
            
            incomingOverlay.style.display = 'none';
            callOverlay.style.display = 'flex';
            callStatus.textContent = 'Initialisation...';
            
            // Initialiser les √©l√©ments vid√©o
            localVideo = document.getElementById('local-video');
            remoteVideo = document.getElementById('remote-video');
            
            // Demander acc√®s cam√©ra et micro
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function(stream) {
                    localStream = stream;
                    if (localVideo) {
                        localVideo.srcObject = stream;
                    }
                    
                    isInCall = true;
                    callStatus.textContent = 'Connect√©';
                    startCallTimer();
                    showVideoContainer();
                    
                    console.log('Appel accept√© avec m√©dia');
                })
                .catch(function(error) {
                    console.error('Erreur acc√®s m√©dia:', error);
                    alert('Impossible d\'acc√©der √† la cam√©ra/microphone.');
                    endCall();
                });
        }
        
        // Fonction pour refuser un appel entrant
        function declineCall() {
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            incomingOverlay.style.display = 'none';
            
            console.log('Appel refus√©');
        }
        
        // Fonction pour terminer l'appel
        function endCall() {
            var callOverlay = document.getElementById('call-overlay');
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            var callBtn = document.getElementById('call-btn');
            var videoContainer = document.getElementById('video-container');
            
            // Calculer la dur√©e si on √©tait en appel
            var duration = 0;
            if (callStartTime) {
                duration = Math.floor((new Date() - callStartTime) / 1000);
            }
            
            // Arr√™ter tous les flux m√©dia
            if (localStream) {
                localStream.getTracks().forEach(function(track) {
                    track.stop();
                });
                localStream = null;
            }
            
            // Fermer la connexion peer
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // R√©initialiser les vid√©os
            if (localVideo) {
                localVideo.srcObject = null;
            }
            if (remoteVideo) {
                remoteVideo.srcObject = null;
            }
            
            isInCall = false;
            callOverlay.style.display = 'none';
            incomingOverlay.style.display = 'none';
            if (videoContainer) {
                videoContainer.style.display = 'none';
            }
            
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
                callStartTime = null;
            }
            
            if (callBtn) {
                callBtn.textContent = 'üìû Appeler';
                callBtn.disabled = false;
            }
            
            // R√©initialiser les √©tats
            isMuted = false;
            isVideoEnabled = true;
            updateMuteButton();
            updateVideoButton();
            
            // Notifier le serveur de la fin d'appel
            if (duration > 0) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/end_call', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.send(JSON.stringify({
                    other_user_id: {{ friend.id }},
                    duration: duration
                }));
            }
            
            console.log('Appel termin√© (dur√©e: ' + duration + 's)');
        }
        
        // Fonction pour activer/d√©sactiver le micro
        function toggleMute() {
            isMuted = !isMuted;
            
            if (localStream) {
                var audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(function(track) {
                    track.enabled = !isMuted;
                });
            }
            
            updateMuteButton();
            console.log('Micro ' + (isMuted ? 'coup√©' : 'activ√©'));
        }
        
        // Fonction pour activer/d√©sactiver la vid√©o
        function toggleVideo() {
            isVideoEnabled = !isVideoEnabled;
            
            if (localStream) {
                var videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(function(track) {
                    track.enabled = isVideoEnabled;
                });
            }
            
            var videoContainer = document.getElementById('video-container');
            if (videoContainer) {
                if (isVideoEnabled) {
                    videoContainer.style.display = 'block';
                } else {
                    videoContainer.style.display = 'none';
                }
            }
            
            updateVideoButton();
            console.log('Vid√©o ' + (isVideoEnabled ? 'activ√©e' : 'd√©sactiv√©e'));
        }
        
        // Mettre √† jour l'ic√¥ne du micro
        function updateMuteButton() {
            var muteBtn = document.getElementById('mute-btn');
            var muteIcon = document.getElementById('mute-icon');
            
            if (muteBtn && muteIcon) {
                if (isMuted) {
                    muteBtn.classList.add('muted');
                    muteIcon.textContent = 'üîá';
                } else {
                    muteBtn.classList.remove('muted');
                    muteIcon.textContent = 'üîä';
                }
            }
        }
        
        // Mettre √† jour l'ic√¥ne de la vid√©o
        function updateVideoButton() {
            var videoIcon = document.getElementById('video-icon');
            
            if (videoIcon) {
                videoIcon.textContent = isVideoEnabled ? 'üìπ' : 'üì∑';
            }
        }
        
        // Timer pour l'appel
        function startCallTimer() {
            callStartTime = new Date();
            callTimer = setInterval(updateCallDuration, 1000);
        }
        
        // Mettre √† jour la dur√©e de l'appel
        function updateCallDuration() {
            if (!callStartTime) return;
            
            var currentTime = new Date();
            var duration = Math.floor((currentTime - callStartTime) / 1000);
            
            var minutes = Math.floor(duration / 60);
            var seconds = duration % 60;
            
            var formattedTime = String(minutes).padStart(2, '0') + ':' + 
                               String(seconds).padStart(2, '0');
            
            var durationElement = document.getElementById('call-duration');
            if (durationElement) {
                durationElement.textContent = formattedTime;
            }
        }
        
        // Simuler un appel entrant (pour tester)
        function simulateIncomingCall(callerName, callerAvatar) {
            if (isInCall) return;
            
            var incomingOverlay = document.getElementById('incoming-call-overlay');
            var callerNameElement = document.getElementById('caller-name');
            var callerAvatarElement = document.getElementById('caller-avatar');
            
            if (callerNameElement) callerNameElement.textContent = callerName;
            if (callerAvatarElement) {
                callerAvatarElement.textContent = callerAvatar || callerName.charAt(0).toUpperCase();
            }
            
            incomingOverlay.style.display = 'flex';
            
            // Son de notification (simulation)
            console.log('üìû Appel entrant de ' + callerName);
        }
        
        // Fonction pour afficher le conteneur vid√©o
        function showVideoContainer() {
            var videoContainer = document.getElementById('video-container');
            if (videoContainer && isVideoEnabled) {
                videoContainer.style.display = 'block';
            }
        }
        
        // V√©rifier la compatibilit√© WebRTC
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.warn('WebRTC n\'est pas support√© sur ce navigateur');
            // L'appel fonctionnera en mode audio/vid√©o simul√© pour la 3DS
        }
    </script>
</body>
</html>