<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat avec {{ friend.username }} - 3DChat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="chat-header">
            <a href="{{ url_for('private_messages') }}?user={{ user.username }}" class="btn btn-small">‚Üê Retour</a>
            <div class="friend-avatar">
                {% if friend.profile_image %}
                    <img src="{{ friend.profile_image }}" alt="Photo de {{ friend.username }}">
                {% else %}
                    {{ friend.username[0].upper() }}
                {% endif %}
            </div>
            <div class="friend-info">
                <div class="friend-name">{{ friend.username }}</div>
                <div class="friend-status {{ 'online' if friend.status == 'online' else 'offline' }}">
                    {{ 'üü¢ En ligne' if friend.status == 'online' else '‚ö´ Hors ligne' }}
                </div>
            </div>
            <a href="{{ url_for('user_profile', user_id=friend.id) }}?user={{ user.username }}" class="btn btn-small">Profil</a>
        </div>

        <div class="chat-messages" id="messages">
            {% for message in messages %}
            <div class="private-message {{ 'own' if message.sender_id == user.id else 'other' }}">
                <div class="message-content">{{ message.content }}</div>
                <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
            </div>
            {% endfor %}
        </div>

        <form class="message-form" id="message-form" onsubmit="sendMessage(event)">
            <div class="form-group">
                <input type="text" id="message-input" name="message" placeholder="Tapez votre message..." maxlength="500" required>
                <button type="submit" class="btn btn-primary" id="send-btn">Envoyer</button>
            </div>
        </form>
    </div>

    <script>
        // D√©tection 3DS
        var is3DS = navigator.userAgent.indexOf('Nintendo 3DS') !== -1;
        var pollingInterval;
        
        function updatePrivateMessages() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_private_messages/{{ friend.id }}?user={{ user.username }}', true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var messagesContainer = document.getElementById('messages');
                    if (messagesContainer) {
                        messagesContainer.innerHTML = xhr.responseText;
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }
            };
            
            xhr.send();
        }
        
        function sendMessage(event) {
            event.preventDefault(); // Emp√™cher le rechargement de page
            
            var messageInput = document.getElementById('message-input');
            var sendBtn = document.getElementById('send-btn');
            var message = messageInput.value.trim();
            
            if (!message) return;
            
            // D√©sactiver le bouton temporairement
            sendBtn.disabled = true;
            sendBtn.textContent = 'Envoi...';
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/send_private_message/{{ friend.id }}?user={{ user.username }}', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    // R√©activer le bouton
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Envoyer';
                    
                    if (xhr.status === 200) {
                        // Vider le champ de message
                        messageInput.value = '';
                        // Mettre √† jour les messages imm√©diatement
                        updatePrivateMessages();
                    }
                }
            };
            
            xhr.send('message=' + encodeURIComponent(message));
        }
        
        // Polling plus agressif pour 3DS
        if (is3DS) {
            // Polling toutes les 1.5 secondes pour 3DS
            pollingInterval = setInterval(updatePrivateMessages, 1500);
            console.log('3DS: Polling activ√© toutes les 1.5s');
        } else {
            // Polling toutes les 3 secondes pour autres navigateurs
            pollingInterval = setInterval(updatePrivateMessages, 3000);
        }
        
        // Auto-scroll vers le bas au chargement initial
        window.onload = function() {
            var messagesContainer = document.getElementById('messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Focus sur le champ de message (pas sur 3DS car √ßa peut causer des probl√®mes)
            if (!is3DS) {
                var messageInput = document.querySelector('input[name="message"]');
                if (messageInput) {
                    messageInput.focus();
                }
            }
        };
        
        // Arr√™ter le polling quand on quitte la page
        window.onbeforeunload = function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        };
    </script>
</body>
</html>